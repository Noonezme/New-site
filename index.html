<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncStream - Watch Videos Together</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fdbb2d;
        }

        .session-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .session-id {
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
        }

        button {
            background: #fdbb2d;
            color: #1a2a6c;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #ffa500;
            transform: translateY(-2px);
        }

        .view-mode-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .view-mode-buttons button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .view-mode-buttons button.active {
            background: #fdbb2d;
            color: #1a2a6c;
        }

        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
        }

        .video-section {
            flex: 2;
        }

        .chat-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .video-container {
            position: relative;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        video {
            width: 100%;
            max-height: 70vh;
            display: block;
        }

        .video-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .video-controls button {
            flex: 1;
            min-width: 120px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message .username {
            font-weight: bold;
            color: #fdbb2d;
            margin-right: 5px;
        }

        .message .time {
            font-size: 0.8rem;
            color: #aaa;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        input, select {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        input::placeholder {
            color: #ccc;
        }

        .user-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-count::before {
            content: "👥";
            font-size: 1.2rem;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #ccc;
            font-size: 0.9rem;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loader .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fdbb2d;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .file-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .video-list {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .video-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .video-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .video-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .video-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #ccc;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #fdbb2d;
        }

        .modal input {
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
            font-size: 1.1rem;
        }

        /* Fullscreen chat notifications */
        .chat-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-left: 4px solid #fdbb2d;
            border-radius: 5px;
            max-width: 300px;
            z-index: 9999;
            animation: notificationAppear 0.5s ease, notificationDisappear 0.5s ease 4.5s forwards;
            display: none;
        }

        @keyframes notificationAppear {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes notificationDisappear {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }

        .chat-notification .username {
            font-weight: bold;
            color: #fdbb2d;
            margin-right: 5px;
        }

        /* View modes */
        .theater-mode .video-section {
            flex: 3;
        }

        .theater-mode .chat-section {
            flex: 1;
        }

        .fullscreen-video-mode .video-section {
            width: 100%;
            flex: none;
        }

        .fullscreen-video-mode .chat-section {
            display: none;
        }

        .fullscreen-chat-mode .video-section {
            display: none;
        }

        .fullscreen-chat-mode .chat-section {
            width: 100%;
            flex: none;
        }

        /* Highlight new messages */
        .message.new {
            background: rgba(253, 187, 45, 0.2);
            border: 1px solid rgba(253, 187, 45, 0.5);
        }

        /* User list */
        .user-list {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 10px;
            margin-top: 5px;
            min-width: 150px;
            display: none;
            z-index: 100;
        }

        .user-list-container {
            position: relative;
        }

        .user-list-container:hover .user-list {
            display: block;
        }

        .user-list div {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-list div:last-child {
            border-bottom: none;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-indicator.connecting {
            background: #ff9800;
        }

        .status-indicator.disconnected {
            background: #f44336;
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>SyncStream 🎬</h1>
            <p>Watch videos together in real-time</p>
            <div class="session-info">
                <div class="session-id">Session: <span id="session-id">MAIN</span></div>
                <div class="user-list-container">
                    <div class="user-count"><span id="user-count">1</span> users online</div>
                    <div class="user-list" id="user-list">
                        <!-- Users will be listed here -->
                    </div>
                </div>
                <div class="connection-status">
                    <div class="status-indicator" id="connection-status"></div>
                    <span id="connection-text">Connected</span>
                </div>
                <button id="copy-link">Copy Session Link</button>
            </div>
            <div class="view-mode-buttons">
                <button id="theater-mode-btn" class="active">Theater Mode</button>
                <button id="fullscreen-video-btn">Fullscreen Video</button>
                <button id="fullscreen-chat-btn">Fullscreen Chat</button>
            </div>
        </header>

        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <video id="video-player" controls>
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="video-controls">
                    <button id="play-btn">▶️ Play</button>
                    <button id="pause-btn">⏸️ Pause</button>
                    <button id="sync-btn">🔄 Sync</button>
                    <button id="fullscreen-btn">📺 Fullscreen</button>
                </div>
                
                <div class="file-upload">
                    <h3>Upload Your Video</h3>
                    <p>Supported formats: MP4, MKV, AVI, MOV, WEBM, and more</p>
                    <div class="file-input">
                        <input type="file" id="video-file" accept="video/*">
                        <button id="upload-btn">Upload</button>
                    </div>
                </div>
                
                <div class="video-list">
                    <h3>Your Videos</h3>
                    <div id="videos-container">
                        <!-- Videos will be listed here -->
                    </div>
                </div>
            </div>

            <div class="chat-section">
                <div class="chat-header">
                    <h3>Chat Room</h3>
                    <div>Online: <span id="chat-user-count">1</span></div>
                </div>
                <div class="messages" id="chat-messages">
                    <div class="message new">
                        <span class="username">System:</span>
                        <span>Welcome to SyncStream! Upload a video to get started.</span>
                        <div class="time">Just now</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <button id="send-btn">Send</button>
                </div>
            </div>
        </div>

        <footer>
            <p>SyncStream - Watch videos together in real-time | Powered by Firebase</p>
        </footer>
    </div>

    <div class="notification" id="notification">Link copied to clipboard!</div>
    <div class="chat-notification" id="chat-notification"></div>

    <div class="modal" id="username-modal">
        <div class="modal-content">
            <h2>Welcome to SyncStream!</h2>
            <p>Please choose a username to get started:</p>
            <input type="text" id="username-input" placeholder="Enter your username" maxlength="20">
            <button id="submit-username">Join Session</button>
        </div>
    </div>

    <script>
        // Firebase configuration - using your provided config
        const firebaseConfig = {
            apiKey: "AIzaSyD5CSVD8q_jKxxnmX65Do1V5NALdX1oYO0",
            authDomain: "wechatwatch-e76ae.firebaseapp.com",
            databaseURL: "https://wechatwatch-e76ae-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wechatwatch-e76ae",
            storageBucket: "wechatwatch-e76ae.firebasestorage.app",
            messagingSenderId: "247455453850",
            appId: "1:247455453850:web:a9481b0e1b825c4cf74523",
            measurementId: "G-WQ9S69L3DY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM elements
        const sessionIdElement = document.getElementById('session-id');
        const userCountElement = document.getElementById('user-count');
        const userListElement = document.getElementById('user-list');
        const chatUserCountElement = document.getElementById('chat-user-count');
        const connectionStatus = document.getElementById('connection-status');
        const connectionText = document.getElementById('connection-text');
        const copyLinkButton = document.getElementById('copy-link');
        const playButton = document.getElementById('play-btn');
        const pauseButton = document.getElementById('pause-btn');
        const syncButton = document.getElementById('sync-btn');
        const fullScreenButton = document.getElementById('fullscreen-btn');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-btn');
        const notification = document.getElementById('notification');
        const chatNotification = document.getElementById('chat-notification');
        const videoPlayer = document.getElementById('video-player');
        const videoFileInput = document.getElementById('video-file');
        const uploadButton = document.getElementById('upload-btn');
        const videosContainer = document.getElementById('videos-container');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const submitUsernameButton = document.getElementById('submit-username');
        const theaterModeBtn = document.getElementById('theater-mode-btn');
        const fullscreenVideoBtn = document.getElementById('fullscreen-video-btn');
        const fullscreenChatBtn = document.getElementById('fullscreen-chat-btn');
        const container = document.querySelector('.container');

        // App state
        let username = null;
        const currentSessionId = "MAIN";
        let videoState = {
            playing: false,
            timestamp: 0,
            videoUrl: null,
            videoName: "No video selected",
            duration: 0
        };
        let storedVideos = JSON.parse(localStorage.getItem('storedVideos')) || {};
        let users = {};
        let isFullscreen = false;
        let currentViewMode = 'theater';
        let isSyncing = false;
        let lastUpdateTime = 0;

        // Initialize the application
        function init() {
            // Check if username is already set
            const savedUsername = localStorage.getItem('username');
            if (savedUsername) {
                username = savedUsername;
                usernameModal.style.display = 'none';
                initializeApp();
            } else {
                usernameModal.style.display = 'flex';
                submitUsernameButton.addEventListener('click', setUsername);
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') setUsername();
                });
            }
        }

        function setUsername() {
            const name = usernameInput.value.trim();
            if (name) {
                username = name;
                localStorage.setItem('username', username);
                usernameModal.style.display = 'none';
                initializeApp();
            }
        }

        function initializeApp() {
            sessionIdElement.textContent = currentSessionId;
            
            // Set up event listeners
            copyLinkButton.addEventListener('click', copySessionLink);
            playButton.addEventListener('click', playVideo);
            pauseButton.addEventListener('click', pauseVideo);
            syncButton.addEventListener('click', syncVideo);
            fullScreenButton.addEventListener('click', toggleFullscreen);
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            uploadButton.addEventListener('click', uploadVideo);
            
            // View mode buttons
            theaterModeBtn.addEventListener('click', () => setViewMode('theater'));
            fullscreenVideoBtn.addEventListener('click', () => setViewMode('fullscreen-video'));
            fullscreenChatBtn.addEventListener('click', () => setViewMode('fullscreen-chat'));
            
            // Set up video event listeners
            videoPlayer.addEventListener('play', handleVideoPlay);
            videoPlayer.addEventListener('pause', handleVideoPause);
            videoPlayer.addEventListener('seeked', handleVideoSeek);
            videoPlayer.addEventListener('timeupdate', handleTimeUpdate);
            videoPlayer.addEventListener('fullscreenchange', handleFullscreenChange);
            videoPlayer.addEventListener('loadedmetadata', handleVideoLoaded);
            
            // Load stored videos
            loadStoredVideos();
            
            // Set up Firebase listeners
            setupFirebaseListeners();
            
            // Add user to the session
            addUserToSession();
            
            // Load initial video state if available
            loadInitialVideoState();
        }

        function setupFirebaseListeners() {
            // Listen for video state changes
            database.ref('sessions/MAIN/videoState').on('value', (snapshot) => {
                const newVideoState = snapshot.val();
                if (newVideoState && !isSyncing) {
                    // Prevent feedback loop
                    if (Date.now() - lastUpdateTime > 500) {
                        updateVideoState(newVideoState);
                    }
                }
            });
            
            // Listen for chat messages
            database.ref('sessions/MAIN/chat').limitToLast(100).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (!document.querySelector(`[data-message-id="${message.id}"]`)) {
                    addMessageToChat(message);
                    
                    // Show notification if in fullscreen mode
                    if (isFullscreen || currentViewMode === 'fullscreen-video') {
                        showChatNotification(message);
                    }
                }
            });
            
            // Listen for user updates
            database.ref('sessions/MAIN/users').on('value', (snapshot) => {
                users = snapshot.val() || {};
                updateUserList();
                
                // Check if our user is in the list, if not add it
                if (username && !users[username]) {
                    addUserToSession();
                }
            });
            
            // Monitor connection status
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    connectionStatus.className = 'status-indicator';
                    connectionText.textContent = 'Connected';
                } else {
                    connectionStatus.className = 'status-indicator disconnected';
                    connectionText.textContent = 'Disconnected';
                }
            });
        }

        function addUserToSession() {
            if (username) {
                database.ref('sessions/MAIN/users/' + username).set({
                    joined: Date.now(),
                    lastActive: Date.now()
                });
                
                // Set up interval to update user activity
                setInterval(() => {
                    if (username) {
                        database.ref('sessions/MAIN/users/' + username + '/lastActive').set(Date.now());
                    }
                }, 10000);
            }
        }

        function updateUserList() {
            const userCount = Object.keys(users).length;
            userCountElement.textContent = userCount;
            chatUserCountElement.textContent = userCount;
            
            // Remove inactive users (more than 30 seconds since last activity)
            const now = Date.now();
            Object.keys(users).forEach(user => {
                if (now - users[user].lastActive > 30000) {
                    database.ref('sessions/MAIN/users/' + user).remove();
                }
            });
            
            userListElement.innerHTML = '';
            Object.keys(users).forEach(user => {
                const userElement = document.createElement('div');
                userElement.textContent = user;
                userListElement.appendChild(userElement);
            });
        }

        function loadInitialVideoState() {
            database.ref('sessions/MAIN/videoState').once('value').then((snapshot) => {
                const savedVideoState = snapshot.val();
                if (savedVideoState && savedVideoState.videoUrl) {
                    updateVideoState(savedVideoState);
                }
            });
        }

        // Save video state to Firebase
        function saveVideoState() {
            if (username) {
                isSyncing = true;
                lastUpdateTime = Date.now();
                database.ref('sessions/MAIN/videoState').set(videoState);
                setTimeout(() => { isSyncing = false; }, 100);
            }
        }

        // Update local video state based on Firebase changes
        function updateVideoState(state) {
            // Don't update if the change is from our own action
            if (state.source === username) return;
            
            videoState = state;
            
            // Only update if the difference is significant
            if (state.videoUrl && videoPlayer.src !== state.videoUrl) {
                videoPlayer.src = state.videoUrl;
                videoPlayer.load();
                
                // Wait for video to load before seeking
                videoPlayer.onloadedmetadata = function() {
                    if (Math.abs(videoPlayer.currentTime - state.timestamp) > 2) {
                        videoPlayer.currentTime = state.timestamp;
                    }
                    
                    if (state.playing && videoPlayer.paused) {
                        videoPlayer.play().catch(e => console.log('Play attempt failed:', e));
                    } else if (!state.playing && !videoPlayer.paused) {
                        videoPlayer.pause();
                    }
                };
            } else {
                if (Math.abs(videoPlayer.currentTime - state.timestamp) > 2) {
                    videoPlayer.currentTime = state.timestamp;
                }
                
                if (state.playing && videoPlayer.paused) {
                    videoPlayer.play().catch(e => console.log('Play attempt failed:', e));
                } else if (!state.playing && !videoPlayer.paused) {
                    videoPlayer.pause();
                }
            }
        }

        // Handle video play event
        function handleVideoPlay() {
            if (isSyncing) return;
            
            videoState.playing = true;
            videoState.timestamp = videoPlayer.currentTime;
            videoState.source = username;
            saveVideoState();
        }

        // Handle video pause event
        function handleVideoPause() {
            if (isSyncing) return;
            
            videoState.playing = false;
            videoState.timestamp = videoPlayer.currentTime;
            videoState.source = username;
            saveVideoState();
        }

        // Handle video seek event
        function handleVideoSeek() {
            if (isSyncing) return;
            
            videoState.timestamp = videoPlayer.currentTime;
            videoState.source = username;
            saveVideoState();
        }

        // Handle time update event
        function handleTimeUpdate() {
            if (isSyncing || videoPlayer.paused) return;
            
            videoState.timestamp = videoPlayer.currentTime;
            videoState.source = username;
            
            // Only update Firebase periodically to reduce load
            if (Date.now() - lastUpdateTime > 1000) {
                saveVideoState();
            }
        }

        // Handle video loaded event
        function handleVideoLoaded() {
            videoState.duration = videoPlayer.duration;
        }

        // Handle fullscreen change event
        function handleFullscreenChange() {
            isFullscreen = !!document.fullscreenElement;
        }

        // Play video and sync with other users
        function playVideo() {
            videoPlayer.play().catch(e => console.log('Play attempt failed:', e));
            videoState.playing = true;
            videoState.timestamp = videoPlayer.currentTime;
            videoState.source = username;
            saveVideoState();
        }

        // Pause video and sync with other users
        function pauseVideo() {
            videoPlayer.pause();
            videoState.playing = false;
            videoState.timestamp = videoPlayer.currentTime;
            videoState.source = username;
            saveVideoState();
        }

        // Sync video with the current state
        function syncVideo() {
            videoState.timestamp = videoPlayer.currentTime;
            videoState.playing = !videoPlayer.paused;
            videoState.source = username;
            saveVideoState();
            showNotification('Video synced!');
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoPlayer.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Set view mode
        function setViewMode(mode) {
            container.classList.remove('theater-mode', 'fullscreen-video-mode', 'fullscreen-chat-mode');
            currentViewMode = mode;
            
            theaterModeBtn.classList.remove('active');
            fullscreenVideoBtn.classList.remove('active');
            fullscreenChatBtn.classList.remove('active');
            
            switch(mode) {
                case 'theater':
                    container.classList.add('theater-mode');
                    theaterModeBtn.classList.add('active');
                    break;
                case 'fullscreen-video':
                    container.classList.add('fullscreen-video-mode');
                    fullscreenVideoBtn.classList.add('active');
                    break;
                case 'fullscreen-chat':
                    container.classList.add('fullscreen-chat-mode');
                    fullscreenChatBtn.classList.add('active');
                    break;
            }
        }

        // Send a chat message
        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText && username) {
                const message = {
                    id: Date.now().toString(),
                    username: username,
                    text: messageText,
                    timestamp: new Date().toISOString()
                };
                
                database.ref('sessions/MAIN/chat').push(message);
                messageInput.value = '';
            }
        }

        // Add a message to the chat UI
        function addMessageToChat(message, isHistory = false) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message' + (isHistory ? '' : ' new');
            messageElement.setAttribute('data-message-id', message.id);
            
            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'username';
            usernameSpan.textContent = message.username + ':';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = message.text;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'time';
            timeDiv.textContent = formatTimestamp(message.timestamp);
            
            messageElement.appendChild(usernameSpan);
            messageElement.appendChild(textSpan);
            messageElement.appendChild(timeDiv);
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Remove the 'new' class after a while
            if (!isHistory) {
                setTimeout(() => {
                    messageElement.classList.remove('new');
                }, 5000);
            }
        }

        // Show chat notification (for fullscreen mode)
        function showChatNotification(message) {
            chatNotification.innerHTML = `
                <span class="username">${message.username}:</span>
                <span>${message.text}</span>
            `;
            chatNotification.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                chatNotification.style.display = 'none';
            }, 5000);
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' minutes ago';
            return date.toLocaleTimeString();
        }

        // Upload video from local storage
        function uploadVideo() {
            const file = videoFileInput.files[0];
            if (!file) {
                showNotification('Please select a video file first');
                return;
            }
            
            const fileName = file.name;
            const fileType = file.type;
            
            // Check if file is a video
            if (!fileType.startsWith('video/')) {
                showNotification('Please select a video file');
                return;
            }
            
            const videoUrl = URL.createObjectURL(file);
            
            // Store video info
            storedVideos[fileName] = {
                url: videoUrl,
                name: fileName,
                type: fileType,
                size: file.size,
                lastAccessed: Date.now()
            };
            
            localStorage.setItem('storedVideos', JSON.stringify(storedVideos));
            
            // Load the video
            loadVideo(fileName, videoUrl);
            
            showNotification(`Video "${fileName}" uploaded successfully!`);
            
            // Clear the file input
            videoFileInput.value = '';
            
            // Reload video list
            loadStoredVideos();
        }

        // Load a video into the player
        function loadVideo(name, url) {
            videoPlayer.src = url;
            videoPlayer.load();
            
            videoState.videoUrl = url;
            videoState.videoName = name;
            videoState.timestamp = 0;
            videoState.playing = false;
            videoState.source = username;
            
            saveVideoState();
            
            // Add a message to chat
            const message = {
                id: Date.now().toString(),
                username: 'System',
                text: `${username} loaded video: ${name}`,
                timestamp: new Date().toISOString()
            };
            
            database.ref('sessions/MAIN/chat').push(message);
            
            showNotification(`Loaded video: ${name}`);
        }

        // Load stored videos from localStorage
        function loadStoredVideos() {
            videosContainer.innerHTML = '';
            
            const videos = Object.entries(storedVideos);
            
            if (videos.length === 0) {
                videosContainer.innerHTML = '<p>No videos uploaded yet.</p>';
                return;
            }
            
            // Sort by last accessed time (newest first)
            videos.sort((a, b) => b[1].lastAccessed - a[1].lastAccessed);
            
            videos.forEach(([name, videoInfo]) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                
                const videoTitle = document.createElement('div');
                videoTitle.className = 'video-title';
                videoTitle.textContent = name;
                
                const videoInfoDiv = document.createElement('div');
                videoInfoDiv.className = 'video-info';
                
                const videoSize = document.createElement('span');
                videoSize.textContent = formatFileSize(videoInfo.size);
                
                const videoType = document.createElement('span');
                videoType.textContent = videoInfo.type;
                
                videoInfoDiv.appendChild(videoSize);
                videoInfoDiv.appendChild(videoType);
                
                videoItem.appendChild(videoTitle);
                videoItem.appendChild(videoInfoDiv);
                
                videoItem.addEventListener('click', () => {
                    // Update last accessed time
                    storedVideos[name].lastAccessed = Date.now();
                    localStorage.setItem('storedVideos', JSON.stringify(storedVideos));
                    
                    loadVideo(name, videoInfo.url);
                });
                
                videosContainer.appendChild(videoItem);
            });
        }

        // Format file size to human readable format
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Copy session link to clipboard
        function copySessionLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Session link copied to clipboard!');
            });
        }

        // Show a notification
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize the app when the page loads
        window.onload = init;
    </script>
</body>
</html>
